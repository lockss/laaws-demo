# Copyright (c) 2000-2018, Board of Trustees of Leland Stanford Jr. University
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without modification,
# are permitted provided that the following conditions are met:
#
# 1. Redistributions of source code must retain the above copyright notice, this
# list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright notice,
# this list of conditions and the following disclaimer in the documentation and/or
# other materials provided with the distribution.
#
# 3. Neither the name of the copyright holder nor the names of its contributors
# may be used to endorse or promote products derived from this software without
# specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
# ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
# ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

version: '3'

services:
  lockss-demo-webui:
    build:
      context: laaws-demo-webui
    image: lockss/laaws-demo-webui
    ports:
      - "80:80"
    links:
      - lockss-metadata-service
      - lockss-repository-service
#      - laaws-openwayback

  lockss-configuration-service:
    image: lockss/laaws-configuration-service:${CFG_VERSION}
    ports:
      - "${CFG_PORT}:${CFG_PORT}"
      - "${CFG_UI}:${CFG_UI}"
    command: "${CFG_CMD}"
    volumes:
      - ./config/cluster:/opt/lockss/config/cluster
      - ./config/host:/opt/lockss/config/host
      - ./config/lockss-configuration-service:/opt/lockss/config/lockss-configuration-service

  lockss-metadata-service:
    image: lockss/laaws-metadata-service:${MDQ_VERSION}
    ports:
      - "${MDQ_PORT}:${MDQ_PORT}"
      - "${MDQ_UI}:${MDQ_UI}"
    command: "${MDQ_CMD}"
    links:
      - lockss-configuration-service
      - lockss-metadata-pgsql
    volumes:
      - ./config/cluster:/opt/lockss/config/cluster
      - ./config/host:/opt/lockss/config/host
      - ./config/lockss-metadata-service:/opt/lockss/config/lockss-metadata-service

  lockss-metadata-extraction-service:
    image: lockss/laaws-metadata-extraction-service:${MDX_VERSION}
    ports:
      - ${MDX_PORT}:${MDX_PORT}
      - ${MDX_UI}:${MDX_UI}
    command: "${MDX_CMD}"
    links:
      - lockss-configuration-service
      - lockss-metadata-pgsql
    volumes:
      - ./config/cluster:/opt/lockss/config/cluster
      - ./config/host:/opt/lockss/config/host
      - ./config/lockss-metadata-extraction-service:/opt/lockss/config/lockss-metadata-extraction-service

  lockss-metadata-pgsql:
    image: postgres:9.6
    ports:
      - "${PGSQL_PORT}:${PGSQL_PORT}"
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB

  lockss-poller:
    image: lockss/laaws-poller:${POL_VERSION}
    ports:
      - ${POL_PORT}:${POL_PORT}
      - ${POL_UI}:${POL_UI}
    command: "${POL_CMD}"
    links:
      - lockss-configuration-service
    volumes:
      - ./config/cluster:/opt/lockss/config/cluster
      - ./config/host:/opt/lockss/config/host
      - ./config/lockss-poller:/opt/lockss/config/lockss-poller

  lockss-repository-service:
    image: lockss/laaws-repository-service:${REPO_VERSION}
    ports:
      - ${REPO_PORT}:${REPO_PORT}
    command: "${REPO_CMD}"
    links:
      - laaws-demo-solr
      - laaws-demo-hdfs
    volumes:
      - ./config/lockss-repository-service:/opt/lockss/config/lockss-repository-service

  laaws-demo-solr:
    build:
      context: laaws-demo-solr
    image: lockss/laaws-demo-solr
    ports:
      - "${SOLR_PORT}:${SOLR_PORT}"
    command: "${SOLR_CMD}"

  laaws-demo-hdfs:
    image:  lockss/laaws-dev-hdfs
    ports:
      - "${HDFS_FSMD}:${HDFS_FSMD}"
      - "${HDFS_DATA}:${HDFS_DATA}"
      - "${HDFS_MD}:${HDFS_MD}"
      - "${HDFS_STATUI}:${HDFS_STATUI}"
      - "${HDFS_DNUI}:${HDFS_DNUI}"
    environment:
      - HDFS_HOST
      - HDFS_FSMD
      - HDFS_DATA
      - HDFS_MD
      - HDFS_STATUI
      - HDFS_DNUI
    volumes:
      - ./config/laaws-demo-hdfs/etc/hadoop:/hadoop/etc/hadoop.custom

  laaws-openwayback:
    image: lockss/laaws-openwayback
    ports:
      - "${WAYBACK_URL_PORT}:${WAYBACK_URL_PORT}"
    links:
      - laaws-demo-hdfs
    environment:
      - HDFS_HOST
      - HDFS_FSMD
      - REPO_BASEDIR
      - WAYBACK_URL_PORT
      - WAYBACK_URL_HOST
      - WAYBACK_BASEDIR
      - WAYBACK_HDFSMNT
      - WAYBACK_WATCHDIR
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN

  laaws-edina-indexer:
    image: lockss/laaws-edina-indexer
    links:
      - laaws-demo-solr
      - laaws-demo-hdfs
    environment:
      - HDFS_HOST
      - HDFS_FSMD
      - REPO_BASEDIR
      - LOCKSS_SOLR_HDFSMNT
      - LOCKSS_SOLR_WATCHDIR
      - LOCKSS_SOLR_URL
    devices:
      - /dev/fuse
    cap_add:
      - SYS_ADMIN